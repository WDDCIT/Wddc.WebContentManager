@{
    ViewBag.Title = "ClientVantage Banners";
}

@section Styles {
    <link href="https://kendo.cdn.telerik.com/2021.2.511/styles/kendo.default.min.css" rel="stylesheet" />
    <link href="https://kendo.cdn.telerik.com/2021.2.511/styles/kendo.bootstrap-v4.min.css" rel="stylesheet" type="text/css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
}

@section Scripts {
    <script src="https://ajax.aspnetcdn.com/ajax/jquery.validate/1.11.0/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <script src="https://kendo.cdn.telerik.com/2021.2.511/js/kendo.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/js/pagination/pagination.min.js"></script>
    <script src="~/js/pagination/pagination.custom.js"></script>

    <script>
        $(document).ready(function () {
            prepareLogList();

            // Handle success/error alerts
            if ('@ViewBag.response') {
                if ('@ViewBag.response' == "Success") {
                    showAlert('success', '@ViewBag.Message');
                } else {
                    showAlert('error', '@ViewBag.Message');
                }
            }

            // Initialize Kendo components
            initializeKendoComponents();
        });

                // Form validation for upload
        function validateUploadForm() {
            let isValid = true;

            // Clear previous errors
            $('#categoryId-error, #bannerName-error, #bannerImage-error').hide().text('');

            // Validate Category
            const categoryValue = $("#upload-form #categoryId").data("kendoDropDownList")?.value();
            if (!categoryValue || categoryValue === "") {
                $('#categoryId-error').text('Category is required').show();
                isValid = false;
            }

            // Validate Banner Name
            const bannerNameValue = $("#upload-form #bannerName").data("kendoTextBox")?.value();
            if (!bannerNameValue || bannerNameValue.trim() === "") {
                $('#bannerName-error').text('Banner name is required').show();
                isValid = false;
            }

            // Validate Banner Image
            const bannerImageFile = $('#upload-form #bannerImage')[0].files[0];
            if (!bannerImageFile) {
                $('#bannerImage-error').text('Banner image is required').show();
                isValid = false;
            } else {
                // Validate file type
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/pjpeg', 'image/x-png'];
                if (!allowedTypes.includes(bannerImageFile.type)) {
                    $('#bannerImage-error').text('File must be an image (jpg, jpeg, png, gif)').show();
                    isValid = false;
                }
            }

            return isValid;
        }

        // Update the form submit handler
        $('#upload-form').on('submit', function(e) {
            e.preventDefault();

            if (!validateUploadForm()) {
                return false;
            }

            const btn = $('#uploadBannerBtn');
            const spinner = startSpinner('spinningWheelUpload');
            btn.prop('disabled', true);

            // Submit the form after a brief delay
            setTimeout(() => {
                this.submit();
            }, 100);
        });

        function showAlert(type, message) {
            const alertId = type === 'success' ? 'success-alert' : 'danger-alert';
            const hideId = type === 'success' ? 'danger-alert' : 'success-alert';
            
            document.getElementById(hideId).style.display = "none";
            document.getElementById(alertId).style.display = "block";
            document.getElementById(alertId).innerHTML = `<strong>${type === 'success' ? 'Success!' : 'Error!'}</strong> ${message}`;
            
            setTimeout(() => {
                $(`#${alertId}`).fadeOut(500);
            }, 5000);
        }

        function initializeKendoComponents() {
            const categoryConfig = {
                dataSource: {
                    transport: {
                        read: {
                            url: '@Url.Action("GetCategories", "CVBanners")',
                            dataType: "json"
                        }
                    }
                },
                dataTextField: "Name",
                dataValueField: "Id",
                filter: "contains"
            };

            $("#upload-form #categoryId").kendoDropDownList(categoryConfig);
            $("#upload-form #bannerName").kendoTextBox({
                maxLength: 100,
                placeholder: "Enter banner name ..."
            });

            $("#update-form #selectedCategoryId").kendoDropDownList({
                ...categoryConfig,
                open: function (e) {
                    $("#banner-toUpdate-row").hide();
                    $("#search-results-update-row").css('visibility', 'hidden');
                }
            });

            $("#update-form #categoryId").kendoDropDownList(categoryConfig);
            $("#update-form #bannerName").kendoTextBox({ maxLength: 100 });

            $("#delete-form #selectedCategoryId").kendoDropDownList({
                ...categoryConfig,
                open: function (e) {
                    $("#search-results-delete-row").css('visibility', 'hidden');
                }
            });
        }

        function searchBannersToUpdate() {
            const spinner = startSpinner("spinningWheelSearchUpdate");
            scrollToElement('#update-collapsible-row');

            $("#search-results-update-row").css('visibility', 'hidden');
            $("#banner-toUpdate-row").hide();
            $('#update-banner-count').hide(); // Hide count when searching

            const selectedCategoryId = $("#update-form #selectedCategoryId").data("kendoDropDownList").value();

            $("#update-form #selectedBannerId").kendoDropDownList({
                dataSource: {
                    transport: {
                        read: {
                            url: `@Url.Action("GetBannersOfCategory", "CVBanners")?categoryId=${selectedCategoryId}`,
                            dataType: "json"
                        }
                    }
                },
                optionLabel: "Filter by banner name ...",
                filter: "contains",
                dataTextField: "Name",
                dataValueField: "Id",
                change: function (e) {
                    this.value() ? searchBannerToUpdate(this.value()) : searchBannersToUpdate();
                }
            });

            loadBanners(selectedCategoryId, 'update', spinner);
        }

         function loadBanners(categoryId, mode, spinner) {
            const listId = mode === 'update' ? 'banners-update-list' : 'banners-delete-list';
            const $list = $(`#${listId}`);
            $list.empty();

            $.getJSON(`@Url.Action("GetBannersOfCategory", "CVBanners")?categoryId=${categoryId}`, function (results) {
                // Update banner count
                const count = results.length;
                const bannerText = count === 1 ? 'banner' : 'banners';

                if (mode === 'update') {
                    renderUpdateBanners(results, $list);
                    $('#update-banner-count').text(`${count} ${bannerText} found`).show();
                } else {
                    renderDeleteBanners(results, $list);
                    $('#delete-banner-count').text(`${count} ${bannerText} found`).show();
                }

                $(`#search-results-${mode}-row`).css('visibility', 'visible');
                stopSpinner(spinner, mode === 'update' ? "spinningWheelSearchUpdate" : "spinningWheelSearchDelete");
            });
        }

        function renderUpdateBanners(results, $list) {
            for (let i = 0; i < results.length; i += 3) {
                const $row = $('<div>').addClass('row img-row content-center');
                let columns = '';

                for (let j = 0; j < 3 && i + j < results.length; j++) {
                    const banner = results[i + j];
                    columns += createBannerCard(banner, 'update');
                }

                $row.html(columns);
                $list.append($row);
            }
        }

        function renderDeleteBanners(results, $list) {
            results.forEach(banner => {
                const $row = $('<div>').addClass('row img-row-delete content-center');
                $row.html(`
                    <div class="col-lg-12 banner-delete-card">
                        <div class="banner-name">${banner.Name}</div>
                        <div class="banner-images">
                            <img class="banner-img" src="../img/banners/${banner.Filename}" alt="${banner.Name}">
                            <img class="banner-img-mobile" src="../img/banners/mobile/${banner.MobileFilename}" alt="${banner.Name} Mobile">
                        </div>
                        <div id="spinningWheelDeleteBanner-${banner.Id}"></div>
                        <button type="button" class="btn btn-danger btn-modern" onclick="deleteBanner('${banner.Name}', '${banner.Id}')">
                            <i class="fa fa-trash"></i> Delete Banner
                        </button>
                    </div>
                `);
                $list.append($row);
            });
        }

        function createBannerCard(banner, mode) {
            return `
                <div class="col-md-4 banner-card">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">${banner.Name}</h6>
                            <img class="card-img" src="../img/banners/${banner.Filename}" alt="${banner.Name}">
                            <div id="spinningWheelSelectBanner-${banner.Id}"></div>
                            <button type="button" class="btn btn-primary btn-modern btn-sm mt-2" 
                                onclick="selectBannerToUpdate('${banner.Id}')">
                                <i class="fa fa-check"></i> Select
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function searchBannerToUpdate(bannerId) {
            const spinner = startSpinner("spinningWheelSearchUpdate");
            $("#search-results-update-row").css('visibility', 'hidden');
            $("#banner-toUpdate-row").hide();
            $('#banners-update-list').empty();

            $.getJSON(`@Url.Action("GetBannerById", "CVBanners")?Id=${bannerId}`, function (result) {
                const $list = $('#banners-update-list');
                $list.html(createBannerCard(result, 'update'));
                // Update count to show 1 banner when filtered
                $('#update-banner-count').text('1 banner found (filtered)').show();
                $("#search-results-update-row").css('visibility', 'visible');
                stopSpinner(spinner, "spinningWheelSearchUpdate");
            });
        }

        function selectBannerToUpdate(bannerId) {
            const spinner = startSpinner(`spinningWheelSelectBanner-${bannerId}`);
            $("#banner-toUpdate-row").hide();

            $.get(`@Url.Action("GetBannerById", "CVBanners")?Id=${bannerId}`, function(result) {
                $("input[name='bannerId']").val(bannerId);
                $("#update-form #categoryId").data("kendoDropDownList").value(
                    $("#update-form #selectedCategoryId").data("kendoDropDownList").value()
                );
                $("#update-form #bannerName").data("kendoTextBox").value(result.Name);
                $("#update-form #bannerImageDisplay").attr('src', `../img/banners/${result.Filename}`);
                
                const mobileSrc = result.HasMobileVersion 
                    ? `../img/banners/mobile/${result.MobileFilename}` 
                    : "../img/no-mobile-banner.png";
                $("#update-form #bannerImageMobileDisplay").attr('src', mobileSrc);

                $("#banner-toUpdate-row").slideDown(400);
                scrollToElement('#banner-toUpdate-row');
                stopSpinner(spinner, `spinningWheelSelectBanner-${bannerId}`);
            });
        }

        function searchBannersToDelete() {
            const spinner = startSpinner("spinningWheelSearchDelete");
            scrollToElement('#delete-collapsible-row');
            $("#search-results-delete-row").css('visibility', 'hidden');
            $('#delete-banner-count').hide(); // Hide count when searching

            const selectedCategoryId = $("#delete-form #selectedCategoryId").data("kendoDropDownList").value();

            $("#delete-form #selectedBannerId").kendoDropDownList({
                dataSource: {
                    transport: {
                        read: {
                            url: `@Url.Action("GetBannersOfCategory", "CVBanners")?categoryId=${selectedCategoryId}`,
                            dataType: "json"
                        }
                    }
                },
                optionLabel: "Filter by banner name ...",
                filter: "contains",
                dataTextField: "Name",
                dataValueField: "Id",
                change: function (e) {
                    this.value() ? searchBannerToDelete(this.value()) : searchBannersToDelete();
                }
            });

            loadBanners(selectedCategoryId, 'delete', spinner);
        }

        function searchBannerToDelete(bannerId) {
            const spinner = startSpinner("spinningWheelSearchDelete");
            $("#search-results-delete-row").css('visibility', 'hidden');
            $('#banners-delete-list').empty();

            $.getJSON(`@Url.Action("GetBannerById", "CVBanners")?Id=${bannerId}`, function (result) {
                renderDeleteBanners([result], $('#banners-delete-list'));
                // Update count to show 1 banner when filtered
                $('#delete-banner-count').text('1 banner found (filtered)').show();
                $("#search-results-delete-row").css('visibility', 'visible');
                stopSpinner(spinner, "spinningWheelSearchDelete");
            });
        }

        function cancelUpdate() {
            $("#banner-toUpdate-row").slideUp(400);
            scrollToElement('#update-collapsible-row');
        }

        function deleteBanner(bannerName, bannerId) {
            Swal.fire({
                title: 'Delete Banner?',
                text: `Are you sure you want to delete "${bannerName}"?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    const spinner = startSpinner(`spinningWheelDeleteBanner-${bannerId}`);
                    
                    $.post(`@Url.Action("DeleteCVBanner", "CVBanners")?bannerId=${bannerId}`, function(response) {
                        if (response.success) {
                            stopSpinner(spinner, `spinningWheelDeleteBanner-${bannerId}`);
                            Swal.fire('Deleted!', `Banner "${bannerName}" has been deleted.`, 'success')
                                .then(() => window.location.href = "@Url.Action("Index", "CVBanners")");
                        } else {
                            Swal.fire('Error', response.message, 'error');
                            prepareLogList();
                            stopSpinner(spinner, `spinningWheelDeleteBanner-${bannerId}`);
                        }
                    }).fail((xhr, status, error) => {
                        Swal.fire('Error', `Failed to delete banner: ${error}`, 'error');
                        prepareLogList();
                        stopSpinner(spinner, `spinningWheelDeleteBanner-${bannerId}`);
                    });
                }
            });
        }

        // File input preview handlers
        function setupFilePreview(inputName, displayId) {
            $(`input[name="${inputName}"]`).on('change', function(e) {
                if (e.target.files[0]) {
                    $(`#${displayId}`).attr('src', URL.createObjectURL(e.target.files[0]));
                }
            });
        }

        setupFilePreview('bannerImage', 'bannerImageDisplay');
        setupFilePreview('bannerImageMobile', 'bannerImageMobileDisplay');
        $('form[name="update-form"] input[name="bannerImage"]').on('change', function(e) {
            if (e.target.files[0]) {
                $('form[name="update-form"] #bannerImageDisplay').attr('src', URL.createObjectURL(e.target.files[0]));
            }
        });
        $('form[name="update-form"] input[name="bannerImageMobile"]').on('change', function(e) {
            if (e.target.files[0]) {
                $('form[name="update-form"] #bannerImageMobileDisplay').attr('src', URL.createObjectURL(e.target.files[0]));
            }
        });

        function prepareLogList() {
            setupPagination('log', 'log-list', '@Url.Action("Log", "CVBanners")?referrerUrl=CVBanners', 
                ['Log', 'Username', 'Created'], 7);
        }

        function toggleLog() {
            $('#log-section').toggleClass('hidden');
            const isHidden = $('#log-section').hasClass('hidden');
            $('#toggle-log-btn').html(`<i class="fa fa-${isHidden ? 'eye' : 'eye-slash'}"></i> ${isHidden ? 'Show' : 'Hide'} Log`);
        }

        function scrollToElement(selector) {
            $('html, body').animate({ scrollTop: $(selector).offset().top - 20 }, 600);
        }

        function startSpinner(targetId) {
            const opts = {
                lines: 13,
                length: 20,
                width: 10,
                radius: 30,
                scale: 1,
                corners: 1,
                color: '#2e6da4',
                fadeColor: 'transparent',
                speed: 1,
                rotate: 0,
                animation: 'spinner-line-fade-quick',
                direction: 1,
                zIndex: 2e9,
                className: 'spinner',
                top: '50%',
                left: '50%',
                shadow: '0 0 1px transparent',
                position: 'absolute'
            };
            const target = document.getElementById(targetId);
            target.classList.add('active'); // Show the spinner container
            return new Spinner(opts).spin(target);
        }

        function stopSpinner(spinner, targetId) {
            spinner.stop();
            const target = document.getElementById(targetId);
            if (target) {
                target.classList.remove('active');
            }
        }

        // Collapsible accordion functionality
        $('.collapsible-btn').on('click', function() {
            const $btn = $(this);
            const $content = $btn.next('.collapsible-content');
            const wasOpen = $btn.hasClass('active');

            // Close all other sections
            $('.collapsible-btn.active').not($btn).each(function() {
                $(this).removeClass('active');
                const $other = $(this).next('.collapsible-content');
                $other.css('maxHeight', '0px');
            });

            // Toggle clicked section
            if (wasOpen) {
                $btn.removeClass('active');
                $content.css('maxHeight', '0px');
            } else {
                $btn.addClass('active');
                $content.css('maxHeight', $content[0].scrollHeight + 'px');
                $content.one('transitionend', function() {
                    if ($content.css('maxHeight') !== '0px') {
                        $content.css('maxHeight', '10000px');
                    }
                });
            }
        });
    </script>
}

<div class="modern-wrapper">
    <!-- Header Section -->
    <div class="page-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-12">
                    <h2 class="page-title">
                        <i class="fa fa-flag"></i> ClientVantage Banners Management
                    </h2>
                    <p class="page-subtitle">
                        Upload, edit, and delete ClientVantage banners on <span class="highlight-red">VantageSuite</span> website
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts -->
    <div class="container-fluid mt-3">
        <div class="alert alert-success modern-alert" id="success-alert" style="display:none"></div>
        <div class="alert alert-danger modern-alert" id="danger-alert" style="display:none"></div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid">
        <!-- Upload Section -->
        <div class="action-card mb-4">
            <button type="button" class="collapsible-btn">
                <i class="fa fa-upload"></i>
                <span>Upload ClientVantage Banner</span>
                <i class="fa fa-chevron-down float-end toggle-icon"></i>
            </button>
            <div class="collapsible-content">
                <form id="upload-form" name="upload-form" method="post"
                      action="@Url.Action("UploadCVBanner", "CVBanners")" enctype="multipart/form-data">
                    <div class="row justify-content-center">
                        <div class="col-lg-2"></div>
                        <div class="col-lg-8">
                            <div class="form-group-modern form-group-large form-group-inline">
                                <label for="categoryId" class="form-label-modern form-label-large form-label-inline">
                                    <i class="fa fa-folder"></i> Category: <span class="text-danger">*</span>
                                </label>
                                <div class="form-input-inline">
                                    <input id="categoryId" name="categoryId" class="form-control-modern form-control-large" required />
                                    <span class="field-validation-error" id="categoryId-error" style="display:none; color: #dc3545; font-size: 0.875rem; margin-top: 5px;"></span>
                                </div>
                            </div>

                            <div class="form-group-modern form-group-large form-group-inline">
                                <label for="bannerName" class="form-label-modern form-label-large form-label-inline">
                                    <i class="fa fa-tag"></i> Banner Name: <span class="text-danger">*</span>
                                </label>
                                <div class="form-input-inline">
                                    <input id="bannerName" name="bannerName" class="form-control-modern form-control-large" required />
                                    <span class="field-validation-error" id="bannerName-error" style="display:none; color: #dc3545; font-size: 0.875rem; margin-top: 5px;"></span>
                                </div>
                            </div>

                            <div class="form-group-modern form-group-large">
                                <div class="form-group-inline">
                                    <label for="bannerImage" class="form-label-modern form-label-large form-label-inline">
                                        <i class="fa fa-image"></i> Banner: <span class="text-danger">*</span>
                                    </label>
                                    <div class="form-input-inline">
                                        <input class="form-control form-control-large" id="bannerImage"
                                               name="bannerImage" type="file" accept="image/*" required>
                                        <span class="field-validation-error" id="bannerImage-error" style="display:none; color: #dc3545; font-size: 0.875rem; margin-top: 5px;"></span>
                                    </div>
                                </div>
                                <div class="text-center mt-3 mb-2">
                                    <img src="../img/no-banner.png" class="img-preview-large img-preview-banner"
                                         id="bannerImageDisplay">
                                </div>
                            </div>

                            <div class="form-group-modern form-group-large">
                                <div class="form-group-inline">
                                    <label for="bannerImageMobile" class="form-label-modern form-label-large form-label-inline">
                                        <i class="fa fa-mobile"></i> Mobile Banner:
                                    </label>
                                    <div class="form-input-inline">
                                        <input class="form-control form-control-large" id="bannerImageMobile"
                                               name="bannerImageMobile" type="file" accept="image/*">
                                    </div>
                                </div>
                                <div class="text-center mt-3 mb-2">
                                    <img src="../img/no-mobile-banner.png" class="img-preview-large img-preview-mobile"
                                         id="bannerImageMobileDisplay">
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2"></div>
                    </div>

                    <div class="form-actions">
                        <div id="spinningWheelUpload"></div>

                        <button type="submit" class="btn btn-primary btn-modern btn-md" id="uploadBannerBtn">
                            <i class="fa fa-cloud-upload"></i> Upload Banner
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Update Section -->
        <div class="action-card mb-4" id="update-collapsible-row">
            <button type="button" class="collapsible-btn">
                <i class="fa fa-edit"></i>
                <span>Update ClientVantage Banner</span>
                <i class="fa fa-chevron-down float-end toggle-icon"></i>
            </button>
            <div class="collapsible-content">
                <form id="update-form" name="update-form" method="post"
                      action="@Url.Action("UpdateCVBanner", "CVBanners")" enctype="multipart/form-data">
                    <input type="hidden" id="bannerId" name="bannerId">

                    <!-- Search Section -->
                    <div class="search-section">
                        <div class="row justify-content-center">
                            <div class="col-lg-2"></div>
                            <div class="col-lg-8">
                                <div class="form-group-modern">
                                    <label for="selectedCategoryId" class="form-label-modern">
                                        <i class="fa fa-search"></i> Search by Category
                                    </label>
                                    <input id="selectedCategoryId" name="selectedCategoryId" class="form-control-modern" />
                                </div>
                                <div class="text-center mt-3">
                                    <div id="spinningWheelSearchUpdate"></div>
                                    <button type="button" class="btn btn-primary btn-modern"
                                            onclick="searchBannersToUpdate()">
                                        <i class="fa fa-search"></i> Search
                                    </button>
                                </div>
                            </div>
                            <div class="col-lg-2"></div>
                        </div>
                    </div>

                    <!-- Search Results -->
                    <div id="search-results-update-row" style="visibility:hidden;" class="mt-4">
                        <div class="row justify-content-center">
                            <div class="col-lg-2"></div>
                            <div class="col-lg-8">
                                <div class="filter-section">
                                    <div id="update-banner-count" class="banner-count-note" style="display:none;">
                                        <i class="fa fa-info-circle"></i> <span>0 banners found</span>
                                    </div>
                                    <input id="selectedBannerId" name="selectedBannerId" />
                                </div>
                                <div id="banners-update-list" class="banners-grid"></div>
                            </div>
                            <div class="col-lg-2"></div>
                        </div>
                    </div>

                    <!-- Update Form -->
                    <div id="banner-toUpdate-row" style="display:none;" class="mt-5">
                        <div class="row justify-content-center">
                            <div class="col-lg-2"></div>
                            <div class="col-lg-8">
                                <div class="update-form-container">
                                    <h5 class="section-title">
                                        <i class="fa fa-edit"></i> Update Selected Banner
                                    </h5>

                                    <!-- Form fields in inline layout like Upload section -->
                                    <div class="form-group-modern form-group-large form-group-inline">
                                        <label for="categoryId" class="form-label-modern form-label-large form-label-inline">
                                            <i class="fa fa-folder"></i> Category:
                                        </label>
                                        <div class="form-input-inline">
                                            <input id="categoryId" name="categoryId" class="form-control-modern form-control-large" />
                                        </div>
                                    </div>

                                    <div class="form-group-modern form-group-large form-group-inline">
                                        <label for="bannerName" class="form-label-modern form-label-large form-label-inline">
                                            <i class="fa fa-tag"></i> Banner Name:
                                        </label>
                                        <div class="form-input-inline">
                                            <input id="bannerName" name="bannerName" class="form-control-modern form-control-large" />
                                        </div>
                                    </div>

                                    <div class="form-group-modern form-group-large">
                                        <div class="form-group-inline">
                                            <label for="bannerImage" class="form-label-modern form-label-large form-label-inline">
                                                <i class="fa fa-image"></i> Banner:
                                            </label>
                                            <div class="form-input-inline">
                                                <input class="form-control form-control-large" id="bannerImage"
                                                       name="bannerImage" type="file" accept="image/*">
                                            </div>
                                        </div>
                                        <div class="text-center mt-3 mb-2">
                                            <img class="img-preview-large img-preview-banner" id="bannerImageDisplay">
                                        </div>
                                    </div>

                                    <div class="form-group-modern form-group-large">
                                        <div class="form-group-inline">
                                            <label for="bannerImageMobile" class="form-label-modern form-label-large form-label-inline">
                                                <i class="fa fa-mobile"></i> Mobile Banner:
                                            </label>
                                            <div class="form-input-inline">
                                                <input class="form-control form-control-large" id="bannerImageMobile"
                                                       name="bannerImageMobile" type="file" accept="image/*">
                                            </div>
                                        </div>
                                        <div class="text-center mt-3 mb-2">
                                            <img class="img-preview-large img-preview-mobile" id="bannerImageMobileDisplay">
                                        </div>
                                    </div>

                                    <div class="form-actions">
                                        <div id="spinningWheelUpdate"></div>
                                        <button type="submit" class="btn btn-primary btn-modern btn-md"
                                                onclick="this.form.submit(); this.disabled=true; startSpinner('spinningWheelUpdate')">
                                            <i class="fa fa-save"></i> Update Banner
                                        </button>
                                        <button type="button" class="btn btn-secondary btn-modern btn-lg"
                                                onclick="cancelUpdate();">
                                            <i class="fa fa-times"></i> Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2"></div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Delete Section -->
        <div class="action-card mb-4" id="delete-collapsible-row">
            <button type="button" class="collapsible-btn">
                <i class="fa fa-trash"></i>
                <span>Delete ClientVantage Banner</span>
                <i class="fa fa-chevron-down float-end toggle-icon"></i>
            </button>
            <div class="collapsible-content">
                <form id="delete-form" name="delete-form">
                    <!-- Search Section -->
                    <div class="search-section">
                        <div class="row justify-content-center">
                            <div class="col-lg-2"></div>
                            <div class="col-lg-8">
                                <div class="form-group-modern">
                                    <label for="selectedCategoryId" class="form-label-modern">
                                        <i class="fa fa-search"></i> Search by Category
                                    </label>
                                    <input id="selectedCategoryId" name="selectedCategoryId" class="form-control-modern" />
                                </div>
                                <div class="text-center mt-3">
                                    <div id="spinningWheelSearchDelete"></div>
                                    <button type="button" class="btn btn-primary btn-modern"
                                            onclick="searchBannersToDelete()">
                                        <i class="fa fa-search"></i> Search
                                    </button>
                                </div>
                            </div>
                            <div class="col-lg-2"></div>
                        </div>
                    </div>

                    <!-- Search Results -->
                    <div id="search-results-delete-row" style="visibility:hidden;" class="mt-4">
                        <div class="row justify-content-center">
                            <div class="col-lg-2"></div>
                            <div class="col-lg-8">
                                <div class="filter-section">
                                    <div id="delete-banner-count" class="banner-count-note" style="display:none;">
                                        <i class="fa fa-info-circle"></i> <span>0 banners found</span>
                                    </div>
                                    <input id="selectedBannerId" name="selectedBannerId" />
                                </div>
                                <div id="banners-delete-list" class="banners-delete-grid"></div>
                            </div>
                            <div class="col-lg-2"></div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Log Section -->
        <div class="log-section-container mt-5">
            <div class="text-center mb-3">
                <button type="button" id="toggle-log-btn" class="btn btn-outline-secondary btn-sm" 
                        onclick="toggleLog()">
                    <i class="fa fa-eye"></i> Show Log
                </button>
            </div>
            <div id="log-section" class="log-content hidden">
                <div id="log">
                    <div class="bs-ObjectList-rows" id="log-list"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>

    #page-heading {
        display: none;
    }

    /* Modern Layout */
    .modern-wrapper {
        background: #f8f9fa;
        min-height: 100vh;
        padding-bottom: 40px;
    }

    .page-header {
        background: transparent;
        color: #333;
        padding: 20px 0;
        margin-bottom: 10px;
        margin-top: 5px;
        padding-left: 15px;  /* ADD THIS LINE - matches Bootstrap container-fluid padding */
    }

    .page-title {
        font-size: 2rem;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 15px;
        color: #1a73e8;
    }

    .page-subtitle {
        margin: 10px 0 0 0;
        color: #666;
        font-size: 1.1rem;
    }

    .highlight-red {
        color: #ff6b6b;
        font-weight: 600;
    }

    /* Modern Alerts */
    .modern-alert {
        border-radius: 12px;
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        font-size: 1rem;
    }

    /* Action Cards */
    /* Action Cards */
    .action-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        margin-bottom: 30px;  /* Change from mb-4 inline style to CSS - increase from ~24px to 30px */
    }

    .action-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    }

    /* Collapsible Button */
    .collapsible-btn {
        width: 100%;
        background: linear-gradient(135deg, #2e6da4 0%, #3d7fb8 100%);
        color: white;
        border: none;
        padding: 20px 30px;
        font-size: 15px;
        font-weight: 600;
        text-align: left;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 15px;
    }

        .collapsible-btn:hover {
            background: linear-gradient(135deg, #245682 0%, #2e6da4 100%);
        }

        .collapsible-btn.active {
            background: linear-gradient(135deg, #245682 0%, #2e6da4 100%);
        }

    .collapsible-btn .toggle-icon {
        transition: transform 0.3s ease;
    }

    .collapsible-btn.active .toggle-icon {
        transform: rotate(180deg);
    }

    /* Collapsible Content */
    .collapsible-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
        padding: 0 30px;
        background: white;
    }

    .action-card .collapsible-btn.active + .collapsible-content {
        padding: 30px;
    }

    /* Modern Form Groups */
    .form-group-modern {
        margin-bottom: 25px;
    }

    .form-label-modern {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1.05rem;
    }

    .form-control-modern {
        width: 100%;
        border-radius: 8px;
        border: 2px solid #e9ecef;
        padding: 10px 15px;
        transition: all 0.3s ease;
    }

    .form-control-modern:focus {
        border-color: #1a73e8;
        box-shadow: 0 0 0 0.2rem rgba(26, 115, 232, 0.25);
    }

    /* Image Previews */
    .image-preview-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
    }

    .preview-group {
        text-align: center;
    }

    .img-preview {
        border: 2px solid #dee2e6;
        border-radius: 8px;
        transition: transform 0.3s ease;
        cursor: pointer;
    }

    .img-preview:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }

    .img-preview-banner {
        height: 100px;
        width: auto;
        max-width: 100%;
    }

    .img-preview-mobile {
        height: 150px;
        width: auto;
        max-width: 100%;
    }

    /* Modern Buttons */
    /* Modern Buttons */
    .btn-modern {
        border-radius: 8px;
        padding: 12px 30px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-modern:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background-color: #6c757d !important;
            border-color: #6c757d !important;
        }

    .btn-modern i {
        margin-right: 8px;
    }

    .form-actions {
        text-align: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 2px solid #e9ecef;
        position: relative;
    }

    /* Search Section */
    .search-section {
        padding: 20px 0;
    }

    .filter-section {
        text-align: center;
        margin-bottom: 20px;
    }

    .filter-section input {
        max-width: 500px;
        margin: 0 auto;
    }

    /* Banner Cards */
    .banners-grid {
        margin-top: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 12px;
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #ced4da; /* Added: Same darker border */
        box-shadow: 0 4px 20px rgba(0,0,0,0.25); /* Added: Same stronger shadow */
    }

    .banner-card {
        margin-bottom: 20px;
    }

    .banner-card .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .banner-card .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    .banner-card .card-body {
        padding: 20px;
        text-align: center;
    }

    .banner-card .card-title {
        font-weight: 600;
        color: #495057;
        margin-bottom: 15px;
    }

    .banner-card .card-img {
        width: 100%;
        height: 80px;
        object-fit: contain;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    /* Delete Banners */
    .banners-delete-grid {
        margin-top: 10px;
        max-height: 700px;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 12px;
        border: 1px solid #ced4da; /* Added: Same lighter grey border */
        box-shadow: 0 4px 20px rgba(0,0,0,0.25); /* Added: Same stronger shadow */
    }

    .banner-delete-card {
        text-align: center;
        padding: 30px;
        background: white;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        transition: transform 0.3s ease;
    }

    .banner-delete-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    }

    .banner-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 20px;
    }

    .banner-images {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 30px;
        margin-bottom: 20px;
    }

    .banner-img {
        height: 80px;
        width: auto;
        max-width: 300px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        /* transition: transform 0.3s ease; */
    }

    .banner-img-mobile {
        height: 120px;
        width: auto;
        max-width: 150px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        /* transition: transform 0.3s ease; */
    }

    /* .banner-img:hover, .banner-img-mobile:hover {
        transform: scale(1.5);
        z-index: 10;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    } */

    /* Update Form Container - Modern style with darker border */
    .update-form-container {
        /* background: #e9ecef; */
        padding: 10px 30px;
        border-radius: 12px;
        margin-top: 20px;
        border: 1px solid #ced4da; /* DARKER border - much more visible */
        box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    }

    .section-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 10px;
        padding-bottom: 15px;
        border-bottom: 2px solid #ced4da; /* Match the darker border color */
    }

    /* Make update form fields match upload section */
    #update-form .update-form-container .form-group-large {
        margin-bottom: 5px;
    }

    #update-form .update-form-container .form-label-large {
        font-size: 1.3rem !important;
        font-weight: 700;
    }


    /* Make update form labels inline like upload */
    #update-form .update-form-container .form-label-inline {
        margin-bottom: 0 !important;
        min-width: 180px;
        flex-shrink: 0;
        justify-content: flex-start;
    }

    #update-form .update-form-container .form-input-inline {
        flex: 1;
    }

    /* Update section Kendo dropdowns to match upload styling */
    #update-form .update-form-container #categoryId + .k-dropdown {
        font-size: 1.2rem !important;
        background: white; /* White background for dropdown */
    }

    #update-form .update-form-container #categoryId + .k-dropdown .k-dropdown-wrap {
        font-size: 1.2rem !important;
        background: white; /* White background */
    }

    #update-form .update-form-container #categoryId + .k-dropdown .k-input {
        font-size: 1.2rem !important;
    }

    /* Update section textbox to match upload styling */
    #update-form .update-form-container #bannerName + .k-textbox {
        font-size: 1.2rem !important;
        background: white; /* White background for textbox */
    }

    /* Log Section */
    .log-section-container {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.08);
    }

    .log-content {
        transition: all 0.4s ease-in-out;
        opacity: 1;
        max-height: 2000px;
        overflow: hidden;
    }

    .log-content.hidden {
        opacity: 0;
        max-height: 0;
        margin-top: 0 !important;
        padding: 0;
    }

    /* Log Table */
    .bs-ObjectList-rows {
        display: table;
        width: 100%;
    }

    .bs-ObjectList-row {
        display: table-row;
        transition: background-color 0.2s ease;
    }

    .bs-ObjectList-row--header {
        background-color: #DCDCDC;
        color: #707070;
    }

    .bs-ObjectList-row--header .bs-ObjectList-cell {
        font-weight: 600;
        padding: 10px 10px;
    }

    .bs-ObjectList-cell {
        display: table-cell;
        padding: 12px 10px;
        vertical-align: middle;
        border-bottom: 1px solid #e9ecef;
    }

    .bs-ObjectList-cell:first-child {
        width: 60%;
        text-align: left;
        white-space: pre-wrap;
    }

    .bs-ObjectList-cell:not(:first-child) {
        width: 20%;
        text-align: center;
    }

    /* Scrollbars */
    .banners-grid::-webkit-scrollbar,
    .banners-delete-grid::-webkit-scrollbar {
        width: 8px;
    }

    .banners-grid::-webkit-scrollbar-track,
    .banners-delete-grid::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .banners-grid::-webkit-scrollbar-thumb,
    .banners-delete-grid::-webkit-scrollbar-thumb {
        background: #1a73e8;
        border-radius: 10px;
    }

    .banners-grid::-webkit-scrollbar-thumb:hover,
    .banners-delete-grid::-webkit-scrollbar-thumb:hover {
        background: #1557b0;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .page-title {
            font-size: 1.5rem;
        }

        .page-subtitle {
            font-size: 1rem;
        }

        .banner-images {
            flex-direction: column;
            gap: 15px;
        }

        .collapsible-btn {
            padding: 15px 20px;
            font-size: 1rem;
        }

        .collapsible-content {
            padding: 0 20px;
        }
    }

    /* Hide breadcrumb */
    .breadcrumb {
        display: none;
    }

    /* Spinner positioning */
    #spinningWheelUpload,
    #spinningWheelUpdate,
    #spinningWheelSearchUpdate,
    #spinningWheelSearchDelete {
        display: none; /* Hidden by default */
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        height: 60px;
        width: 60px;
        z-index: 100;
    }

        #spinningWheelUpload.active,
        #spinningWheelUpdate.active,
        #spinningWheelSearchUpdate.active,
        #spinningWheelSearchDelete.active {
            display: block;
        }


    /* Large form elements for upload section */
    .form-group-large {
        margin-bottom: 5px; /* CHANGED: decreased from 35px to 20px */
    }

    .form-label-large {
        font-size: 1.3rem !important;
        font-weight: 700;
    }

    .form-control-large {
        font-size: 1.2rem !important;
       /*  padding: 14px 18px !important; */
        /* min-height: 50px; */
    }

    .img-preview-large {
        border: 3px solid #dee2e6;
        border-radius: 10px;
        transition: none; /* CHANGED: removed transition */
        cursor: default; /* CHANGED: changed from pointer to default */
    }

        .img-preview-large.img-preview-banner {
            height: 80px; /* CHANGED: reduced from 120px to 80px */
            width: auto;
            max-width: 100%;
        }

        .img-preview-large.img-preview-mobile {
            height: 120px; /* CHANGED: reduced from 180px to 120px */
            width: auto;
            max-width: 100%;
        }

    /* Inline form layout for compact display */
    .form-group-inline {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .form-label-inline {
        margin-bottom: 0 !important;
        min-width: 180px;
        flex-shrink: 0;
        justify-content: flex-start;
    }

    .form-input-inline {
        flex: 1;
    }

    /* Validation styles */
    .field-validation-error {
        display: block;
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 5px;
    }

    .text-danger {
        color: #dc3545;
    }

    .form-control-modern.error,
    .k-dropdown.error .k-dropdown-wrap {
        border-color: #dc3545 !important;
    }

    .form-control-modern:focus.error {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }

    /* Make delete section category dropdown match upload section styling */
    #delete-form #selectedCategoryId {
        font-size: 1.2rem !important;
    }

    /* Match the Kendo dropdown wrapper for delete section */
    #delete-form .k-dropdown {
        font-size: 1.2rem !important;
    }

        #delete-form .k-dropdown .k-dropdown-wrap {
            font-size: 1.2rem !important;
            /* padding: 10px 15px !important; */
        }

        #delete-form .k-dropdown .k-input {
            font-size: 1.2rem !important;
        }

    /* Make delete section banner filter dropdown wider */
    #delete-form #selectedBannerId {
        width: 100% !important;
        max-width: 100% !important;
        font-size: 1.1rem !important;
    }

    #delete-form .filter-section {
        text-align: left; /* Changed from center to left */
        margin-bottom: 20px;
    }

        #delete-form .filter-section input {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0;
        }

        /* Match Kendo dropdown styling for banner filter in delete section */
        #delete-form #selectedBannerId + .k-dropdown,
        #delete-form .filter-section .k-dropdown {
            width: 100% !important;
            max-width: 100% !important;
        }

            #delete-form #selectedBannerId + .k-dropdown .k-dropdown-wrap,
            #delete-form .filter-section .k-dropdown .k-dropdown-wrap {
                font-size: 1.1rem !important;
                width: 100% !important;
            }

        #delete-form .filter-section .k-input {
            font-size: 1.1rem !important;
        }

    /* Scrollbars - Enhanced for better visibility */
    .banners-grid::-webkit-scrollbar,
    .banners-delete-grid::-webkit-scrollbar {
        width: 12px; /* Increased from 8px to 12px */
    }

    .banners-grid::-webkit-scrollbar-track,
    .banners-delete-grid::-webkit-scrollbar-track {
        background: #e9ecef; /* Changed from #f1f1f1 for better contrast */
        border-radius: 10px;
        border: 1px solid #dee2e6; /* Added border for definition */
    }

    .banners-grid::-webkit-scrollbar-thumb,
    .banners-delete-grid::-webkit-scrollbar-thumb {
        background: #2e6da4; /* Changed from #1a73e8 to match theme */
        border-radius: 10px;
        border: 2px solid #e9ecef; /* Added border for better visibility */
    }

        .banners-grid::-webkit-scrollbar-thumb:hover,
        .banners-delete-grid::-webkit-scrollbar-thumb:hover {
            background: #245682; /* Changed from #1557b0 to match theme */
        }

    /* Make delete section scrollbar even more prominent */
    .banners-delete-grid::-webkit-scrollbar {
        width: 14px; /* Even wider for delete section */
    }

    .banners-delete-grid::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #2e6da4 0%, #245682 100%);
        box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
    }

    /* Banner count note in delete section */
    .banner-count-note {
        background: #e3f2fd;
        color: #1976d2;
        padding: 5px 10px;
        border-radius: 8px;
        margin-bottom: 5px;
        font-size: 0.95rem;
        font-weight: 600;
        border-left: 4px solid #2196f3;
        text-align: left;
    }

        .banner-count-note i {
            margin-right: 8px;
        }

    /* Make update section category dropdown match upload/delete section styling */
    #update-form #selectedCategoryId {
        font-size: 1.2rem !important;
    }

    /* Match the Kendo dropdown wrapper for update section */
    #update-form .k-dropdown {
        font-size: 1.2rem !important;
    }

        #update-form .k-dropdown .k-dropdown-wrap {
            font-size: 1.2rem !important;
        }

        #update-form .k-dropdown .k-input {
            font-size: 1.2rem !important;
        }

    #update-form #selectedBannerId {
        width: 100% !important;
        max-width: 100% !important;
        font-size: 1.1rem !important;
    }

    #update-form .filter-section {
        text-align: left;
        margin-bottom: 20px;
    }

        #update-form .filter-section input {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0;
        }

        /* Match Kendo dropdown styling for banner filter in update section */
        #update-form #selectedBannerId + .k-dropdown,
        #update-form .filter-section .k-dropdown {
            width: 100% !important;
            max-width: 100% !important;
        }

            #update-form #selectedBannerId + .k-dropdown .k-dropdown-wrap,
            #update-form .filter-section .k-dropdown .k-dropdown-wrap {
                font-size: 1.1rem !important;
                width: 100% !important;
            }

        #update-form .filter-section .k-input {
            font-size: 1.1rem !important;
        }

</style>